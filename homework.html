<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="icon" href="favicon.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Number Problems</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #050505;
            --primary-hover: #2563eb;
            --primary-dark: #0f172a;
            --primary-light: #94a3b8;
            --text-color: #f8fafc;
            --text-muted: #94a3b8;
            --background-color: #0a0a0a;
            --card-bg: #141212;
            --card-border: #1e293b;
            --shadow: rgba(0, 0, 0, 0.4);
            --popup-bg: #1e293b;
            --header-bg: #0a0a0a;
            --header-color: #ffffff;
            --accent-glow: rgba(59, 130, 246, 0.2);
            --radius-lg: 16px;
            --radius-md: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--background-color);
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
            background-size: 50px 50px;
            color: var(--text-color);
            line-height: 1.5;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .quote-container {
            max-width: 800px;
            margin: 2rem auto 0;
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.02);
            border: 1px border var(--card-border);
            border-radius: var(--radius-md);
            text-align: center;
            position: relative;
            transition: opacity 0.5s ease;
        }

        #quoteText {
            font-style: italic;
            font-size: 1.1rem;
            color: var(--text-color);
            margin-bottom: 0.5rem;
            display: block;
        }

        #quoteAuthor {
            font-size: 0.85rem;
            color: var(--primary-hover);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        header {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            color: var(--header-color);
            padding: 0.75rem 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid var(--card-border);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
            gap: 1.5rem;
        }

        .logo {
            font-size: 1.6rem;
            font-weight: 900;
            display: flex;
            align-items: center;
            gap: 10px;
            letter-spacing: -0.5px;
            cursor: pointer;
            flex-shrink: 0;
            text-shadow: 0 0 1px rgba(255,255,255,0.3);
        }

        .logo i { color: #ffffff; }

        .search-container {
            display: flex;
            gap: 8px;
            flex: 1;
            max-width: 700px;
        }

        #searchBar {
            padding: 0.75rem 1.25rem;
            border-radius: var(--radius-md);
            border: 1px solid var(--card-border);
            flex-grow: 1;
            font-size: 15px;
            background: rgba(255, 255, 255, 0.03);
            color: white;
            transition: all 0.2s ease;
        }

        #searchBar:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.07);
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        #sortOptions {
            padding: 0.85rem 1.2rem;
            border-radius: 12px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            font-size: 16px;
            background: #1e293b;
            color: white;
            min-width: 140px;
            cursor: pointer;
            font-weight: 500;
        }

        #settings {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 0.85rem 1.8rem;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
            font-weight: 600;
        }

        #settings:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .stats-bar {
            padding: 0.75rem 1rem;
            background: rgba(15, 23, 42, 0.4);
            border-bottom: 1px solid var(--card-border);
        }

        .stats-content {
            max-width: 1400px;
            margin: 0 auto;
            font-size: 0.875rem;
            color: var(--text-muted);
            font-weight: 500;
        }

        main {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem 1rem 4rem;
        }

        #container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 1.25rem;
        }

        @media (min-width: 640px) {
            #container { grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); }
        }

        .zone-item {
            background-color: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: var(--radius-lg);
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .zone-item:hover {
            transform: translateY(-4px);
            border-color: var(--primary-color);
            box-shadow: 0 12px 24px -10px rgba(0,0,0,0.5);
        }

        .zone-item.featured { border: 1.5px solid var(--primary-color); }

        .zone-item.featured::before {
            content: "FEATURED";
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--primary-color);
            color: white;
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 0.65rem;
            font-weight: 800;
            z-index: 10;
        }

        .zone-item img {
            width: 100%;
            height: 160px;
            object-fit: cover;
            transition: transform 0.5s ease;
            filter: grayscale(20%);
        }

        .zone-item:hover img { transform: scale(1.08); }

        .zone-info {
            padding: 1rem;
            background: linear-gradient(to bottom, transparent, rgba(0,0,0,0.2));
        }

        .zone-name {
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--text-color);
            display: -webkit-box;
            -webkit-line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-align: center;
        }

        #zoneViewer {
            position: fixed;
            inset: 0;
            background-color: #000;
            z-index: 10000;
            display: none;
            flex-direction: column;
        }

        .zone-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #0f172a;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #1e293b;
        }

        .zone-title {
            display: flex;
            flex-direction: column;
            overflow: hidden;
            margin-right: 1rem;
        }

        #zoneName {
            font-size: 1.1rem;
            font-weight: 700;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #zoneAuthor {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .zone-controls {
            display: flex;
            gap: 6px;
        }

        .zone-controls button {
            background: #1e293b;
            border: 1px solid #334155;
            color: white;
            padding: 0.6rem 0.8rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .zone-controls button:hover {
            background: var(--primary-color);
            border-color: var(--primary-color);
        }

        .zone-controls button span { display: none; }

        @media (min-width: 1024px) {
            .zone-controls button span { display: inline; }
            .zone-controls { gap: 10px; }
        }

        #zoneFrame { flex-grow: 1; border: none; background: #fff; }

        #popupOverlay {
            position: fixed;
            inset: 0;
            background-color: rgba(2, 6, 23, 0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            backdrop-filter: blur(8px);
            padding: 1rem;
        }

        .popup {
            background-color: var(--card-bg);
            border-radius: var(--radius-lg);
            width: 100%;
            max-width: 440px;
            animation: popupIn 0.2s cubic-bezier(0.16, 1, 0.3, 1);
            border: 1px solid var(--card-border);
            overflow-y: auto;
            max-height: 90vh;
        }

        @keyframes popupIn {
            from { opacity: 0; transform: scale(0.95) translateY(10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .popup-header {
            padding: 1.25rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--card-border);
            position: sticky;
            top: 0;
            background: var(--card-bg);
            z-index: 10;
        }

        .btn-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }

        .btn {
            padding: 0.85rem;
            border-radius: var(--radius-md);
            border: 1px solid transparent;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-weight: 600;
        }

        .btn-primary { background: var(--primary-color); color: white; }
        .btn-primary:hover { background: var(--primary-hover); }

        .btn-secondary { background: #1e293b; color: white; border-color: #334155; }
        .btn-secondary:hover { background: #334155; }

        .loading {
            grid-column: 1 / -1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 4rem 0;
            color: var(--text-muted);
        }

        .loading i { font-size: 2.5rem; color: var(--primary-color); margin-bottom: 1rem; }

        .setting-item { margin-bottom: 1.25rem; }
        .setting-label { display: block; margin-bottom: 0.5rem; font-size: 0.85rem; color: #94a3b8; font-weight: 600; }
        .setting-input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #334155; background: #0f172a; color: white; font-size: 14px; }
        
        .credits-section {
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid var(--card-border);
            text-align: center;
        }

        .credits-list { font-size: 0.85rem; color: #94a3b8; line-height: 1.8; }
        .credits-list strong { color: white; }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--background-color); }
        ::-webkit-scrollbar-thumb { background: var(--card-border); border-radius: 10px; }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="logo">
                <i class="fas fa-gamepad"></i>
                <span>NikeHub</span>
            </div>
            
            <div class="search-container">
                <input type="text" id="searchBar" placeholder="Search Zones">
                <select id="sortOptions">
                    <option value="popular">Popular</option>
                    <option value="name">Name</option>
                    <option value="id">ID</option>
                </select>
            </div>
            
            <button id="settings">
                <i class="fas fa-sliders-h"></i>
                <span>Settings</span>
            </button>
        </div>
    </header>

    <div class="stats-bar">
        <div class="stats-content">
            <span id="zoneCount">Discovering zones...</span>
        </div>
    </div>

    <main>
        <div class="quote-container" id="quoteContainer">
            <span id="quoteText">"Loading daily wisdom..."</span>
            <span id="quoteAuthor">- NikeHub</span>
        </div>

        <div id="container" style="margin-top: 2rem;">
            <div class="loading">
                <i class="fas fa-circle-notch fa-spin"></i>
                <p>Initializing Library...</p>
            </div>
        </div>
    </main>

    <div id="zoneViewer">
        <div class="zone-header">
            <div class="zone-title">
                <h2 id="zoneName">Zone Title</h2>
                <span id="zoneId" style="display: none;"></span>
                <a id="zoneAuthor" href="#" target="_blank">
                    <i class="fas fa-circle-check"></i>
                    <span>Verified Creator</span>
                </a>
            </div>
            <div class="zone-controls">
                <button onclick="fullscreenZone()">
                    <i class="fas fa-expand"></i>
                    <span>Fullscreen</span>
                </button>
                <button onclick="downloadZone()">
                    <i class="fas fa-download"></i>
                    <span>Save</span>
                </button>
                <button onclick="closeZone()" style="background: #7f1d1d; border-color: #991b1b;">
                    <i class="fas fa-times"></i>
                    <span>Close</span>
                </button>
            </div>
        </div>
        <iframe id="zoneFrame"></iframe>
    </div>

    <div id="popupOverlay">
        <div class="popup">
            <div class="popup-header">
                <h3 id="popupTitle" style="font-weight: 700;">Settings</h3>
                <button id="popupClose" style="background:none; border:none; color:var(--text-muted); font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>
            <div id="popupBody" style="padding: 1.5rem;">
            </div>
        </div>
    </div>

    <footer style="text-align: center; padding: 40px 20px; color: var(--text-muted); font-size: 0.8rem; letter-spacing: 0.5px;">
        Made with ‚ù§Ô∏è by nikegtag &bull; Love you all for the support! If you want, you can donate to my Cash App At $NikeGtag
    </footer>

    <script>
        
        // nikehub blocklist cuz im a genius */
        const BLOCKLIST = {
            ids: [],
            names: ["Soundboard", "[!] COMMENTS", "spam"] // Block specific names (partial match)
        };

        const CUSTOM_ZONES = [
            // format if i wanna add more games but im a chud so i prob wont
            // {
            //     id: 99999,
            //     name: "tung tung game or sum",
            //     author: "You",
            //     cover: "https://example.com/cover.png",
            //     url: "https://example.com/game.html",
            //     isExternal: true,
            //     featured: true
            // }
        ];

        // MULTIPLE CDNs: Load from ALL of these simultaneously, deduplicate across all
        const CDN_SOURCES = [
            {
                name: "gn-math",
                zones: "https://cdn.jsdelivr.net/gh/gn-math/assets@latest/zones.json",
                covers: "https://cdn.jsdelivr.net/gh/gn-math/covers@main",
                html: "https://cdn.jsdelivr.net/gh/gn-math/html@main"
            },
            {
                name: "noseygames",
                zones: "https://cdn.jsdelivr.net/gh/NoseyGames/data@main/zones.json",
                covers: "https://cdn.jsdelivr.net/gh/NoseyGames/covers@latest/",
                html: "https://cdn.jsdelivr.net/gh/gn-math/html@main"
            },
            {
                name: "gn-math",
                zones: "https://cdn.jsdelivr.net/gh/gn-math/assets@latest/zones.json",
                covers: "https://cdn.jsdelivr.net/gh/gn-math/covers@main",
                html: "https://cdn.jsdelivr.net/gh/gn-math/html@main"
            }
            // all the tuff cdns
        ];

 
        let zoneSourceMap = new Map(); // zone.id -> CDN source object

        /* --- uwu quotes --- */
        const quotes = [
            { text: "this could be a sign to donate to me on cash app or IRL twin. Cash app is $nikegtag üôè" author: "NikeGtag"
            { text: "Your gay.", author: "Classroomspot" },
            { text: "Umm i had some beef.", author: "Classroomspot" },
            { text: "ugh i hate working on my ui", author: "NikeGtag" },
            { text: "OMG nikehub is the most tuff site to ever exist.", author: "defo said by gn math üôè" },
            { text: "Reality is merely an illusion, albeit a very persistent one.", author: "idk bro dont ask me" },
            { text: "PLEASEEE promote me", author: "GN-Math" },
            { text: "What kind of mango is this?", author: "Some tikt–æk" },
            { text: "Dawg take a shower", author: "Unknown Hub" }
        ];

        function updateQuote() {
            const quoteEl = document.getElementById('quoteText');
            const authorEl = document.getElementById('quoteAuthor');
            const container = document.getElementById('quoteContainer');
            
            const randomQuote = quotes[Math.floor(Math.random() * quotes.length)];
            
            container.style.opacity = 0;
            setTimeout(() => {
                quoteEl.textContent = `"${randomQuote.text}"`;
                authorEl.textContent = `- ${randomQuote.author}`;
                container.style.opacity = 1;
            }, 500);
        }

        // rotate every 30 secs
        updateQuote();
        setInterval(updateQuote, 30000);

        /* --- dont touch this logic it is importantt --- */
        const container = document.getElementById('container');
        const zoneViewer = document.getElementById('zoneViewer');
        let zoneFrame = document.getElementById('zoneFrame');
        const searchBar = document.getElementById('searchBar');
        const sortOptions = document.getElementById('sortOptions');
        const customZonesURL = "/customzones.json";

        let config = {
            panicKey: localStorage.getItem('panicKey') || '1',
            panicUrl: localStorage.getItem('panicUrl') || 'https://launchpad.classlink.com/login',
            cloakTitle: localStorage.getItem('cloakTitle') || 'Number Problems',
            cloakIcon: localStorage.getItem('cloakIcon') || 'favicon.png'
        };

        let customEntries = [];
        let zones = [];
        let popularityData = {};

        // Check if zone is blocked by ID or name
        function isBlocked(zone) {
            // Check ID blocklist
            if (BLOCKLIST.ids.includes(zone.id)) return true;
            
            // Check name blocklist (case-insensitive partial match)
            const zoneNameLower = zone.name.toLowerCase();
            for (let blockedName of BLOCKLIST.names) {
                if (zoneNameLower.includes(blockedName.toLowerCase())) return true;
            }
            
            return false;
        }

        // deduplitator
        function deduplicateZones(zoneList) {
            const seen = new Set();
            const uniqueZones = [];
            
            zoneList.forEach(item => {
                if (!seen.has(item.zone.id)) {
                    seen.add(item.zone.id);
                    zoneSourceMap.set(item.zone.id, item.source);
                    uniqueZones.push(item.zone);
                }
            });
            
            return uniqueZones;
        }

        // Load zones from a single CDN
        async function loadFromCDN(cdn) {
            try {
                const response = await fetch(cdn.zones + "?t=" + Date.now());
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                console.log(`Loaded ${data.length} zones from ${cdn.name}`);
                return data.map(zone => ({ zone, source: cdn }));
            } catch (e) {
                console.warn(`Failed to load from ${cdn.name}:`, e.message);
                return [];
            }
        }

        // Load zones from /customzones.json file
        async function loadCustomZonesFile() {
            try {
                const response = await fetch(customZonesURL + "?t=" + Date.now());
                if (!response.ok) throw new Error('File not found');
                const data = await response.json();
                console.log(`Loaded ${data.length} zones from ${customZonesURL}`);
                // Custom zones from file
                return data.map(zone => ({ zone, source: CDN_SOURCES[0] }));
            } catch (error) {
                console.warn('No custom zones file found:', error.message);
                return [];
            }
        }

        // Load hardcoded custom zones
        function loadHardcodedCustomZones() {
            if (CUSTOM_ZONES.length === 0) return [];
            console.log(`Loaded ${CUSTOM_ZONES.length} hardcoded custom zones`);
            // Hardcoded zones use the first cdn cuz thats tuff as their source
            return CUSTOM_ZONES.map(zone => ({ zone, source: CDN_SOURCES[0] }));
        }

        async function listZones() {
            try {
                // same time boi
                const loadPromises = [
                    loadHardcodedCustomZones(), // Hardcoded zones (same time cuz im a genuine master coder)
                    loadCustomZonesFile(),      // From /customzones.json
                    ...CDN_SOURCES.map(cdn => loadFromCDN(cdn)) // From all CDNs
                ];
                
                const results = await Promise.all(loadPromises);
                const allZoneItems = results.flat(); // Combine all arrays
                
                if (allZoneItems.length === 0) {
                    throw new Error("No zones loaded from any source");
                }
                
                zones = deduplicateZones(allZoneItems);
                
                // Filter blocked zones
                zones = zones.filter(zone => !isBlocked(zone));
                
                await fetchPopularity();
                sortZones();
                document.getElementById('zoneCount').textContent = `${zones.length} zones available from ${CDN_SOURCES.length} sources. Have fun!`;
            } catch (error) {
                container.innerHTML = `<div class="loading"><h3>Offline Mode Active</h3><p>Could not reach any CDN server.</p></div>`;
            }
        }

        async function fetchPopularity() {
            try {
                // Try multiple CDNs for stats
                for (let cdn of CDN_SOURCES) {
                    try {
                        const statsUrl = `https://data.jsdelivr.com/v1/stats/packages/gh/gn-math/html@main/files?period=year`;
                        const response = await fetch(statsUrl);
                        if (response.ok) {
                            const data = await response.json();
                            data.forEach(file => {
                                const idMatch = file.name.match(/\/(\d+)\.html$/);
                                if (idMatch) popularityData[parseInt(idMatch[1])] = file.hits.total;
                            });
                            break;
                        }
                    } catch (e) {}
                }
            } catch (e) {}
        }

        function sortZones() {
            const sortBy = sortOptions.value;
            let sortedZones = [...zones];
            
            if (sortBy === 'name') sortedZones.sort((a, b) => a.name.localeCompare(b.name));
            else if (sortBy === 'id') sortedZones.sort((a, b) => a.id - b.id);
            else if (sortBy === 'popular') sortedZones.sort((a, b) => (popularityData[b.id] || 0) - (popularityData[a.id] || 0));
            
            sortedZones.sort((a, b) => (a.isExternal ? -1 : b.isExternal ? 1 : 0));
            sortedZones.sort((a, b) => (a.name === "[!] SUGGEST GAMES ‚Ä¢ Tiktok" ? -1 : b.name === "[!] SUGGEST GAMES ‚Ä¢ Tiktok" ? 1 : 0));
            
            displayZones(sortedZones);
        }

        function displayZones(zonesToShow) {
            container.innerHTML = "";
            zonesToShow.forEach(file => {
                const zoneItem = document.createElement("div");
                zoneItem.className = "zone-item";
                if (file.featured) zoneItem.classList.add('featured');
                zoneItem.onclick = () => openZone(file);
                
                const img = document.createElement("img");
                img.loading = "lazy";
                
                // Get the source CDN for this zone
                const sourceCDN = zoneSourceMap.get(file.id) || CDN_SOURCES[0];
                
                if (file.isExternal) {
                    img.src = file.cover;
                } else {
                    img.src = file.cover
                        .replace("{COVER_URL}", sourceCDN.covers)
                        .replace("{HTML_URL}", sourceCDN.html);
                }
                
                img.onerror = function() { this.src = 'https://via.placeholder.com/300x200/0f172a/94a3b8?text=' + encodeURIComponent(file.name); };
                
                const zoneInfo = document.createElement("div");
                zoneInfo.className = "zone-info";
                const zoneName = document.createElement("div");
                zoneName.className = "zone-name";
                zoneName.textContent = file.name;
                
                zoneInfo.appendChild(zoneName);
                zoneItem.appendChild(img);
                zoneItem.appendChild(zoneInfo);
                container.appendChild(zoneItem);
            });
        }

        function openZone(file) {
            if (file.name === "[!] SUGGEST GAMES ‚Ä¢ Tiktok") {
                window.open(file.url, "_blank");
                return;
            }

            const viewer = document.getElementById('zoneViewer');
            let oldFrame = document.getElementById('zoneFrame');
            const newFrame = document.createElement('iframe');
            newFrame.id = 'zoneFrame';
            
            oldFrame.parentNode.replaceChild(newFrame, oldFrame);
            zoneFrame = newFrame; 


            const sourceCDN = zoneSourceMap.get(file.id) || CDN_SOURCES[0];

            if (file.isExternal) {
                zoneFrame.src = file.url;
            } else {
                const url = file.url
                    .replace("{COVER_URL}", sourceCDN.covers)
                    .replace("{HTML_URL}", sourceCDN.html);
                    
                fetch(url).then(res => res.text()).then(html => {
                    const doc = zoneFrame.contentDocument || zoneFrame.contentWindow.document;
                    doc.open();
                    doc.write(html);
                    doc.close();
                });
            }

            document.getElementById('zoneName').textContent = file.name;
            document.getElementById('zoneId').textContent = file.id;
            document.getElementById('zoneAuthor').innerHTML = `<i class="fas fa-circle-check"></i> by ${file.author}`;
            zoneViewer.style.display = "flex";
            document.body.style.overflow = 'hidden';
            zoneFrame.style.cursor = 'auto';
        }

        function closeZone() {
            const viewer = document.getElementById('zoneViewer');
            viewer.style.display = "none";
            
            if (zoneFrame) {
                zoneFrame.src = "about:blank";
                try {
                    const doc = zoneFrame.contentDocument || zoneFrame.contentWindow.document;
                    doc.open();
                    doc.write("");
                    doc.close();
                } catch(e) {
                    console.log("Cross-origin frame cleared via src only.");
                }
            }
            
            document.body.style.overflow = 'auto';
        }

        function fullscreenZone() { if (zoneFrame.requestFullscreen) zoneFrame.requestFullscreen(); }

        function aboutBlank() {
            const win = window.open("about:blank", "_blank");
            const zoneIdText = document.getElementById('zoneId').textContent;
            const zone = zones.find(z => (z.id + '') === zoneIdText);
            if (zone) {
                if (zone.isExternal) win.location.href = zone.url;
                else {
                    const sourceCDN = zoneSourceMap.get(zone.id) || CDN_SOURCES[0];
                    fetch(zone.url.replace("{HTML_URL}", sourceCDN.html)).then(r => r.text()).then(h => {
                        win.document.open(); win.document.write(h); win.document.close();
                    });
                }
            }
        }

        function downloadZone() {
            const zoneId = document.getElementById('zoneId').textContent;
            const zone = zones.find(z => (z.id + '') === zoneId);
            if (zone && !zone.isExternal) {
                const sourceCDN = zoneSourceMap.get(zone.id) || CDN_SOURCES[0];
                fetch(zone.url.replace("{HTML_URL}", sourceCDN.html)).then(r => r.text()).then(t => {
                    const blob = new Blob([t], {type: "text/html"});
                    const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
                    a.download = zone.name + ".html"; a.click();
                });
            } else alert("Download restricted for external URLs.");
        }

        function applyCloak() {
            document.title = config.cloakTitle;
            const link = document.querySelector("link[rel*='icon']") || document.createElement('link');
            link.type = 'image/x-icon'; link.rel = 'shortcut icon'; link.href = config.cloakIcon;
            document.getElementsByTagName('head')[0].appendChild(link);
        }

        function openSettings() {
            document.getElementById('popupTitle').textContent = "Settings & Config";
            document.getElementById('popupBody').innerHTML = `
                <div class="setting-item">
                    <label class="setting-label">Tab Title</label>
                    <input type="text" class="setting-input" value="${config.cloakTitle}" oninput="updateConfig('cloakTitle', this.value)">
                </div>
                <div class="setting-item">
                    <label class="setting-label">Favicon URL</label>
                    <input type="text" class="setting-input" value="${config.cloakIcon}" oninput="updateConfig('cloakIcon', this.value)">
                </div>
                <div class="setting-item">
                    <label class="setting-label">Panic Switch Key</label>
                    <input type="text" class="setting-input" maxlength="1" value="${config.panicKey}" oninput="updateConfig('panicKey', this.value)">
                </div>
                <div class="setting-item">
                    <label class="setting-label">Panic Redirect URL</label>
                    <input type="text" class="setting-input" value="${config.panicUrl}" oninput="updateConfig('panicUrl', this.value)">
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="saveData()"><i class="fas fa-download"></i> Export</button>
                    <label class="btn btn-secondary" style="margin:0; cursor:pointer;"><i class="fas fa-upload"></i> Import <input type="file" style="display:none" onchange="loadData(event)"></label>
                </div>

                <div class="setting-item" style="margin-top: 1.5rem;">
                    <button class="btn btn-primary" onclick="showContact()" style="width: 100%;">
                        <i class="fas fa-envelope"></i> Contact Support
                    </button>
                </div>

                <div class="credits-section">
                    <div class="credits-list">
                        <strong>NikeHub</strong><br>
                        Lead Developer: <strong>nikegtag</strong><br>
                        Data & Assets: <strong>gn-math / NikeGtag</strong><br>
                        Special Thanks To: <strong>The Community, Seriously. Thanks for the support.</strong>
                        Hey! If your reading you clearly use the site. It would be great if you donated to me on cash app. <strong>$NikeGtag</strong>
                    </div>
                </div>
            `;
            document.getElementById('popupOverlay').style.display = "flex";
        }

        function showContact() {
            document.getElementById('popupTitle').textContent = "Support";
            document.getElementById('popupBody').innerHTML = `
                <div style="text-align: center; padding: 1rem;">
                    <i class="fas fa-paper-plane" style="font-size: 3rem; color: var(--primary-color); margin-bottom: 1.5rem;"></i>
                    <p style="color: white; font-size: 1.1rem; margin-bottom: 0.5rem;">Need help or have suggestions?</p>
                    <p style="color: var(--text-muted); margin-bottom: 2rem;">Message us on TikTok for the fastest response.</p>
                    <a href="https://www.tiktok.com/@gnmath" target="_blank" class="btn btn-primary" style="text-decoration: none;">
                        <i class="fab fa-tiktok"></i> @gnmath
                    </a>
                    <button class="btn btn-secondary" onclick="openSettings()" style="width: 100%; margin-top: 1rem;">
                        Back to Settings
                    </button>
                </div>
            `;
        }

        function updateConfig(key, val) {
            config[key] = val;
            localStorage.setItem(key, val);
            if (key === 'cloakTitle' || key === 'cloakIcon') applyCloak();
        }

        function saveData() {
            const blob = new Blob([JSON.stringify(localStorage)], {type: "application/json"});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
            a.download = "nikehub-settings.json"; a.click();
        }

        function loadData(event) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = JSON.parse(e.target.result);
                for (let k in data) localStorage.setItem(k, data[k]);
                location.reload();
            };
            reader.readAsText(event.target.files[0]);
        }

        document.getElementById('settings').addEventListener('click', openSettings);
        document.getElementById('popupClose').addEventListener('click', () => document.getElementById('popupOverlay').style.display = "none");
        
        searchBar.addEventListener('input', (e) => {
            const q = e.target.value.toLowerCase();
            displayZones(zones.filter(z => z.name.toLowerCase().includes(q)));
        })

        sortOptions.addEventListener('change', sortZones);

        document.addEventListener('keydown', (e) => {
            if (e.key.toLowerCase() === config.panicKey.toLowerCase()) window.location.replace(config.panicUrl);
            if (e.key === 'Escape') closeZone();
        });

        applyCloak();
        listZones();
    </script>
</body>
</html>
