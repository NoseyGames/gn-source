<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Groq AI Interface</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { border: "#27272a", background: "#09090b", foreground: "#fafafa" } } }
        }
    </script>
    <style>
        body { background-color: #09090b; color: #fafafa; font-family: sans-serif; }
        .code-font { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
        .cursor::after { content: 'â–‹'; animation: blink 1s step-start infinite; }
        @keyframes blink { 50% { opacity: 0; } }
        pre::-webkit-scrollbar { height: 8px; }
        pre::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 10px; }
    </style>
</head>
<body class="p-8 flex flex-col items-center">

    <div class="w-full max-w-2xl space-y-6">
        <div class="flex justify-between items-center border-b border-zinc-800 pb-4">
            <h1 class="text-xl font-semibold tracking-tight">Groq <span class="text-zinc-500 text-sm font-normal text-xs uppercase ml-2 tracking-widest">Llama 3.3</span></h1>
            
            <div class="flex items-center gap-4">
                <div id="key-container" class="hidden flex items-center gap-2 animate-in slide-in-from-right-4">
                    <input id="api-key-input" type="password" placeholder="Enter Groq Key..." 
                        class="text-xs bg-zinc-900 border border-zinc-800 rounded px-2 py-1 focus:ring-1 focus:ring-zinc-700 outline-none w-40">
                    <button onclick="saveKey()" class="text-[10px] bg-zinc-200 text-black px-2 py-1 rounded font-bold hover:bg-white transition">SAVE</button>
                </div>
                
                <button onclick="toggleKeyInput()" class="text-zinc-500 hover:text-zinc-200 transition">
                    <i data-lucide="key" class="w-4 h-4"></i>
                </button>
                <button onclick="clearChat()" class="text-zinc-500 hover:text-zinc-200 transition">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                </button>
            </div>
        </div>

        <div class="flex gap-2">
            <input id="user-input" type="text" onkeypress="if(event.key==='Enter') askGroq()" 
                placeholder="Ask Groq anything..." 
                class="flex-1 bg-zinc-900 border border-zinc-800 rounded-lg px-4 py-2.5 focus:outline-none focus:ring-1 focus:ring-zinc-700 transition shadow-inner">
            <button onclick="askGroq()" id="send-btn" class="bg-zinc-100 text-black px-5 py-2 rounded-lg font-medium hover:bg-white transition flex items-center active:scale-95">
                <i data-lucide="send" class="w-4 h-4"></i>
            </button>
        </div>

        <div id="ai-root" class="w-full min-h-[100px] pb-20"></div>
    </div>

    <script>
        // ==========================================
        // CONFIGURATION & PERSISTENCE
        // ==========================================
        let GROQ_API_KEY = localStorage.getItem('groq_key') || "";
        const SYSTEM_PROMPT = "You are Gemini, a helpful AI assistant. Always use Markdown for code and formatting.";
        const MODEL = "llama-3.3-70b-versatile"; 

        function toggleKeyInput() {
            const container = document.getElementById('key-container');
            container.classList.toggle('hidden');
        }

        function saveKey() {
            const val = document.getElementById('api-key-input').value;
            if (val) {
                localStorage.setItem('groq_key', val);
                GROQ_API_KEY = val;
                alert("Key saved to local storage!");
                document.getElementById('key-container').classList.add('hidden');
            }
        }

        // ==========================================
        // CORE API LOGIC
        // ==========================================
        let fullResponseBuffer = "";

        async function askGroq() {
            if (!GROQ_API_KEY) {
                alert("Please click the key icon and enter your Groq API Key first!");
                return;
            }

            const inputField = document.getElementById('user-input');
            const userText = inputField.value;
            if (!userText) return;

            inputField.value = "";
            const root = document.getElementById('ai-root');
            
            // Create container for this specific message
            const messageId = 'msg-' + Math.random().toString(36).substring(7);
            root.insertAdjacentHTML('afterbegin', `<div id="${messageId}" class='group relative animate-in fade-in duration-500 mb-8 border-b border-zinc-900 pb-6'><div class='stream-target prose prose-invert max-w-none text-sm leading-relaxed text-zinc-300 cursor'></div></div>`);
            
            fullResponseBuffer = "";
            const target = root.querySelector(`#${messageId} .stream-target`);
            
            try {
                const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${GROQ_API_KEY}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        model: MODEL,
                        messages: [
                            { role: "system", content: SYSTEM_PROMPT },
                            { role: "user", content: userText }
                        ],
                        stream: true,
                    })
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split("\n");

                    for (const line of lines) {
                        if (line.startsWith("data: ") && line !== "data: [DONE]") {
                            try {
                                const data = JSON.parse(line.substring(6));
                                const content = data.choices[0].delta.content || "";
                                fullResponseBuffer += content;
                                target.innerHTML = marked.parse(fullResponseBuffer);
                                lucide.createIcons(); // keep icons alive during stream if any
                            } catch (e) {}
                        }
                    }
                }

                target.classList.remove('cursor');
                finalizeUI(fullResponseBuffer, root.querySelector(`#${messageId}`));

            } catch (err) {
                target.innerHTML = `<span class='text-red-500'>Error: ${err.message}</span>`;
            }
        }

        function finalizeUI(text, messageContainer) {
            const parts = parseContent(text);
            const target = messageContainer.querySelector('.stream-target');
            
            let finalHtml = `<div>`;
            parts.forEach(part => {
                if (part.type === "code") {
                    finalHtml += createCodeBlock(part.content, part.language);
                } else {
                    finalHtml += `<div class="text-zinc-300 text-sm leading-relaxed mb-4 prose prose-invert">${marked.parse(part.content)}</div>`;
                }
            });

            finalHtml += `</div><div class="flex items-center gap-2 pt-2 opacity-0 group-hover:opacity-100 transition-opacity">
                <button onclick="copyText('${btoa(unescape(encodeURIComponent(text)))}', this)" class="flex items-center h-8 px-2 text-zinc-500 hover:text-zinc-200 transition">
                    <i data-lucide="copy" class="w-4 h-4 mr-1.5"></i> <span class="text-xs">Copy</span>
                </button>
            </div>`;

            target.innerHTML = finalHtml;
            lucide.createIcons();
        }

        // --- Same Parser & Component Logic from before ---
        function parseContent(text) {
            const parts = [];
            const codeBlockRegex = /```(\w+)?\n?([\s\S]*?)```/g;
            let lastIndex = 0; let match;
            while ((match = codeBlockRegex.exec(text)) !== null) {
                if (match.index > lastIndex) parts.push({ type: "text", content: text.slice(lastIndex, match.index) });
                parts.push({ type: "code", content: match[2].trim(), language: match[1] || "code" });
                lastIndex = match.index + match[0].length;
            }
            if (lastIndex < text.length) parts.push({ type: "text", content: text.slice(lastIndex) });
            return parts;
        }

        function createCodeBlock(code, language) {
            const isHTML = language.toLowerCase() === "html" || code.trim().startsWith("<");
            const id = Math.random().toString(36).substring(7);
            return `
                <div class="relative my-4 rounded-lg overflow-hidden border border-zinc-800 bg-zinc-950/50">
                    <div class="flex items-center justify-between px-3 py-2 bg-zinc-900/80 border-b border-zinc-800 text-xs text-zinc-500">
                        <span class="font-mono uppercase font-bold">${language}</span>
                        <div class="flex items-center gap-1">
                            ${isHTML ? `<button onclick="togglePreview('${id}')" class="flex items-center h-7 px-2 hover:text-zinc-100 transition"><i data-lucide="play" class="w-3 h-3 mr-1"></i> Preview</button>` : ''}
                            <button onclick="copyText('${btoa(unescape(encodeURIComponent(code)))}', this)" class="flex items-center h-7 px-2 hover:text-zinc-100 transition"><i data-lucide="copy" class="w-3 h-3 mr-1"></i> Copy</button>
                        </div>
                    </div>
                    <div id="preview-${id}" class="hidden"><iframe srcdoc="${code.replace(/"/g, '&quot;')}" class="w-full min-h-[200px] bg-white"></iframe></div>
                    <pre class="p-4 overflow-x-auto text-sm code-font text-zinc-300"><code>${code.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}</code></pre>
                </div>`;
        }

        async function copyText(base64, btn) {
            const text = decodeURIComponent(escape(atob(base64)));
            await navigator.clipboard.writeText(text);
            const original = btn.innerHTML;
            btn.innerHTML = `<i data-lucide="check" class="w-3.5 h-3.5 mr-1 text-green-500"></i> <span class="text-green-500">Copied</span>`;
            lucide.createIcons();
            setTimeout(() => { btn.innerHTML = original; lucide.createIcons(); }, 2000);
        }

        function togglePreview(id) { document.getElementById(`preview-${id}`).classList.toggle('hidden'); }
        function clearChat() { document.getElementById('ai-root').innerHTML = ''; }
        lucide.createIcons();
    </script>
</body>
</html>
