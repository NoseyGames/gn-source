<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>IXL | Dashboard</title>
  <link id="favicon-link" rel="icon" href="https://www.google.com/s2/favicons?sz=64&domain=ixl.com" type="image/png">
  
  <script type="importmap">
    {
      "imports": {
        "codemirror": "https://esm.sh/codemirror@6.0.1",
        "@codemirror/lang-html": "https://esm.sh/@codemirror/lang-html@6.4.9",
        "@codemirror/theme-one-dark": "https://esm.sh/@codemirror/theme-one-dark@6.1.2"
      }
    }
  </script>

  <style>
    body { margin: 0; font-family: 'Segoe UI', Arial, sans-serif; background: #181a1b; color: #e8e6e3; overflow: hidden; }
    header { 
      padding: 10px 20px; 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      background: #242729; 
      border-bottom: 1px solid #3e4446; 
    }
    h1 { margin: 0; font-size: 1.1rem; color: #007bff; }
    #editor-container { height: calc(100vh - 110px); margin: 10px; border-radius: 4px; border: 1px solid #3e4446; overflow: hidden; }
    .cm-editor { height: 100%; }
    
    .button-group { display: flex; gap: 10px; align-items: center; }
    button { 
      padding: 8px 16px; 
      font-size: 14px; 
      cursor: pointer; 
      border: none; 
      border-radius: 4px; 
      font-weight: 600; 
      transition: opacity 0.2s;
    }
    .btn-preview { background: #007bff; color: white; }
    .btn-download { background: #28a745; color: white; }
    button:hover { opacity: 0.8; }
    
    #status { font-size: 11px; color: #888; }
  </style>
</head>
<body>

  <header>
    <h1>HTML Builder</h1>
    <div class="button-group">
      <span id="status">Last saved: Never</span>
      <button class="btn-download" onclick="downloadHTML()">Download .html</button>
      <button class="btn-preview" onclick="launch()">View Site In-Page</button>
    </div>
  </header>

  <div id="editor-container"></div>

  <script type="module">
    import { EditorView, basicSetup } from "codemirror";
    import { html } from "@codemirror/lang-html";
    import { oneDark } from "@codemirror/theme-one-dark";

    const savedCode = localStorage.getItem('user-html-code') || "<!DOCTYPE html>\n<html>\n<body>\n  <h1>New Project</h1>\n</body>\n</html>";

    const editor = new EditorView({
      doc: savedCode,
      extensions: [
        basicSetup,
        html(),
        oneDark,
        EditorView.updateListener.of((update) => {
          if (update.docChanged) {
            const code = update.state.doc.toString();
            localStorage.setItem('user-html-code', code);
            document.getElementById('status').innerText = "Saved: " + new Date().toLocaleTimeString();
          }
        })
      ],
      parent: document.getElementById('editor-container')
    });

    window.editor = editor;

    // --- NEW: Download Function ---
    window.downloadHTML = function() {
      const code = window.editor.state.doc.toString();
      const blob = new Blob([code], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = 'index.html'; // Default filename
      document.body.appendChild(a);
      a.click();
      
      // Cleanup
      setTimeout(() => {
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
      }, 0);
    };

    // Preview Function
    window.launch = function() {
      const code = window.editor.state.doc.toString();
      const iframe = document.createElement('iframe');
      Object.assign(iframe.style, {
        position: 'fixed', top: 0, left: 0, width: '100%', height: '100%',
        border: 'none', background: 'white', zIndex: '9999'
      });
      iframe.srcdoc = code;
      document.body.appendChild(iframe);

      const closeBtn = document.createElement('button');
      closeBtn.textContent = 'Exit Preview';
      Object.assign(closeBtn.style, {
        position: 'fixed', bottom: '20px', right: '20px', zIndex: '10000',
        background: '#dc3545', color: 'white', padding: '10px 20px'
      });
      document.body.appendChild(closeBtn);
      closeBtn.onclick = () => { iframe.remove(); closeBtn.remove(); };
    };

    document.addEventListener('keydown', e => {
      if (e.ctrlKey && e.key === 'Enter') window.launch();
      if (e.ctrlKey && e.key === 's') {
        e.preventDefault(); // Stop browser from opening its own save dialog
        window.downloadHTML();
      }
    });
  </script>
</body>
</html>
